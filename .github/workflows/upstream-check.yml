name: Check Upstream Version

on:
  # Disable until upstream enables releases
  # schedule:
  #   # Run weekly on Monday at 9am UTC
  #   - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-version:
    name: Check for new go_link releases
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          CURRENT=$(grep 'GO_LINK_VERSION' version.bzl | cut -d'"' -f2)
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT"

      - name: Check latest release
        id: latest
        run: |
          LATEST=$(curl -s https://api.github.com/repos/tree-sitter/go-tree-sitter/releases/latest | jq -r .tag_name | sed 's/^v//')
          echo "version=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST"

      - name: Compare versions
        id: compare
        run: |
          if [ "${{ steps.current.outputs.version }}" != "${{ steps.latest.outputs.version }}" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "::notice::New version available: ${{ steps.latest.outputs.version }}"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "::notice::Already at latest version"
          fi

      - name: Create issue for new version
        if: steps.compare.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const currentVersion = '${{ steps.current.outputs.version }}';
            const latestVersion = '${{ steps.latest.outputs.version }}';

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-update'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes(latestVersion)
            );

            if (existingIssue) {
              console.log('Issue already exists:', existingIssue.html_url);
              return;
            }

            // Create new issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Update to go_link v${latestVersion}`,
              labels: ['upstream-update', 'enhancement'],
              body: `A new version of go_link is available!

            **Current version:** ${currentVersion}
            **Latest version:** ${latestVersion}

            ## Update steps

            1. Update \`GO_LINK_VERSION\` in \`version.bzl\`
            2. Run \`./print_sha.bash\` to compute the new integrity hash
            3. Update \`GO_LINK_INTEGRITY\` in \`version.bzl\`
            4. Verify the patch still applies: \`bazelisk build //:go_link\`
            5. Test the build thoroughly
            6. Update \`CHANGELOG.md\`
            7. Update version mapping table in \`README.md\`

            ## Release notes

            https://github.com/tree-sitter/go-tree-sitter/releases/tag/v${latestVersion}

            ---
            *This issue was automatically created by the upstream-check workflow.*`
            });

            console.log('Created issue:', issue.data.html_url);

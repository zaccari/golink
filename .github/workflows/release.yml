name: Release

on:
  push:
    tags:
      - 'v*.*.*' # Trigger on version tags like v0.25.0, v1.0.0, etc.

permissions:
  contents: write # Required to create releases

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Fetch all history for changelog generation

      - name: Verify build works
        uses: bazelbuild/setup-bazelisk@v3
      - name: Build release
        run: |
          bazelisk build //...

      - name: Get tag version
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Verify module version matches tag
        run: |
          MODULE_VERSION=$(grep 'version = ' MODULE.bazel | head -1 | cut -d'"' -f2)
          TAG_VERSION=${{ steps.version.outputs.version }}

          if [ "$MODULE_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::MODULE.bazel version ($MODULE_VERSION) does not match tag version ($TAG_VERSION)"
            echo "Please update the version in MODULE.bazel to match the git tag"
            exit 1
          fi

          echo "âœ“ Version check passed: $MODULE_VERSION"

      - name: Prepare release notes and artifacts
        run: .github/scripts/release_prep.bash > release_notes.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.txt
          draft: true
          prerelease: true
          generate_release_notes: true # Includes auto-generated notes from commits
          fail_on_unmatched_files: true
          files: go_link-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## Release Created! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
